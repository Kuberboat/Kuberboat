version: '1.0'
name: pr-ci
displayName: pr-pipeline
triggers:
  trigger: auto
  push:
    branches:
      exclude:
        - main
  pr:
    branches:
      precise:
        - main
variables:
  DOCKER_IMAGE: p9t.io/kuberboat/ci:1.1.4
  DOCKER_CONTAINER: kuberboat-ci-test
  REPO_NAME: kuberboat
  TEST_FMT_PATH: ./test/test_fmt.sh
stages:
  - name: container
    displayName: Create Container
    strategy: fast
    trigger: auto
    steps:
      - step: shell@agent
        name: create-container
        displayName: Create Container
        hostGroupID: test
        script: |-
          docker ps -q --filter "name=${DOCKER_CONTAINER}" | grep -q . && docker stop ${DOCKER_CONTAINER} && docker rm ${DOCKER_CONTAINER}
          docker run --privileged -d -t --name ${DOCKER_CONTAINER} ${DOCKER_IMAGE}
  - name: clone
    displayName: Clone Repo
    strategy: fast
    trigger: auto
    steps:
      - step: shell@agent
        name: clone
        displayName: Clone Repo
        hostGroupID: test
        script: |-
          docker exec ${DOCKER_CONTAINER} bash -c '\
            git clone -b ${GITEE_SOURCE_BRANCH} git@gitee.com:xx01cyx/kuberboat.git; \
            cd ${REPO_NAME}'
          if [ $? -ne 0 ]
          then exit 1
          fi
  - name: test
    displayName: Test
    strategy: naturally
    trigger: auto
    steps:
      - step: shell@agent
        name: format
        displayName: Test Format
        hostGroupID: test
        script: |-
          docker exec ${DOCKER_CONTAINER} bash -c '\
            cd ${REPO_NAME}; \
            chmod +x ${TEST_FMT_PATH}; \
            ./${TEST_FMT_PATH}'
          exit $?
      - step: shell@agent
        name: build
        displayName: Test Build
        hostGroupID: test
        script: |-
          docker exec ${DOCKER_CONTAINER} bash -c '\
            source ~/.bashrc; \
            cd ${REPO_NAME}; \
            make'
          exit $?
permissions:
  - role: admin
    members: []
